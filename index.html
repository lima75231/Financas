<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle Financeiro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f9fa;
    }

    h1, h2 {
      text-align: center;
      color: #333;
    }

    form, .filtros, .navegacao-mes {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    input, select, button {
      padding: 8px;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #343a40;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    tr.pendente {
      background-color: #fff3cd;
    }

    .acoes button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      margin: 0 4px;
    }

    canvas {
      max-width: 600px;
      margin: 20px auto;
      display: block;
    }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        font-size: 14px;
      }

      form, .filtros, .navegacao-mes {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <h1>Controle Financeiro</h1>

  <form id="form">
    <input type="text" id="descricao" placeholder="Descri√ß√£o" required>
    <input type="text" id="valor" placeholder="Valor (ex: 112,53)" required>
    <input type="date" id="vencimento" required>
    <select id="tipo">
      <option value="entrada">Entrada</option>
      <option value="saida">Sa√≠da</option>
    </select>
    <select id="status">
      <option value="pago">Pago</option>
      <option value="pendente">Pendente</option>
    </select>
    <button type="submit">Adicionar</button>
  </form>

  <div class="navegacao-mes">
  <button id="mesAnterior">‚Üê M√™s Anterior</button>
  <strong id="mesAtualTexto"></strong>
  <button id="proximoMes">Pr√≥ximo M√™s ‚Üí</button>
</div>

<table>
  <thead>
    <tr>
      <th>Descri√ß√£o</th>
      <th>Valor</th>
      <th>Tipo</th>
      <th>Vencimento</th>
      <th>Status</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="tabela"></tbody>
</table>

<!-- ‚úÖ Totais Mensais Aqui -->
<div id="resumoMensal" style="text-align:center; margin-top: 20px; font-size: 18px; font-weight: bold;"></div>

<h2>Resumo Financeiro Mensal</h2>
<canvas id="grafico"></canvas>

<script>
  const API_URL = 'https://sheetdb.io/api/v1/vr5v5x0y9am0j';
  const form = document.getElementById('form');
  const tabela = document.getElementById('tabela');
  const mesAtualTexto = document.getElementById('mesAtualTexto');
  const mesAnteriorBtn = document.getElementById('mesAnterior');
  const proximoMesBtn = document.getElementById('proximoMes');
  const resumoMensal = document.getElementById('resumoMensal');
  let grafico;

  let dadosOriginais = [];
  let mesesDisponiveis = [];
  let indiceMesAtual = 0;

  form.onsubmit = async (e) => {
    e.preventDefault();
    const novo = {
      id: Date.now().toString(),
      descricao: form.descricao.value,
      valor: form.valor.value.replace(',', '.'),
      tipo: form.tipo.value,
      vencimento: formatarData(form.vencimento.value),
      status: form.status.value
    };
    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: novo })
    });
    form.reset();
    carregarDados();
  };

  function formatarData(dataISO) {
    if (!dataISO) return '';
    const [ano, mes, dia] = dataISO.split('-');
    return `${dia}/${mes}/${ano}`;
  }

  function formatarDataParaFiltro(data) {
    const [dia, mes, ano] = data.split('/');
    return { dia, mes, ano };
  }

  async function carregarDados() {
    const res = await fetch(API_URL);
    const dados = await res.json();
    dadosOriginais = dados;

    const chavesMesAno = new Set();
    dados.forEach(item => {
      const { mes, ano } = formatarDataParaFiltro(item.vencimento);
      chavesMesAno.add(`${mes}/${ano}`);
    });

    mesesDisponiveis = Array.from(chavesMesAno).sort((a, b) => {
      const [m1, y1] = a.split('/');
      const [m2, y2] = b.split('/');
      return new Date(`${y1}-${m1}-01`) - new Date(`${y2}-${m2}-01`);
    });

    if (indiceMesAtual >= mesesDisponiveis.length) indiceMesAtual = mesesDisponiveis.length - 1;

    atualizarTela();
  }

  function atualizarTela() {
    const chave = mesesDisponiveis[indiceMesAtual];
    const [mesSelecionado, anoSelecionado] = chave.split('/');
    mesAtualTexto.textContent = `${mesSelecionado}/${anoSelecionado}`;

    tabela.innerHTML = '';
    let entradas = 0, saidas = 0;

    dadosOriginais.forEach((item) => {
      const { mes, ano } = formatarDataParaFiltro(item.vencimento);
      if (mes === mesSelecionado && ano === anoSelecionado) {
        const tr = document.createElement('tr');
        if (item.status === 'pendente') tr.classList.add('pendente');

        const valorNum = parseFloat(item.valor);
        tr.innerHTML = `
          <td>${item.descricao}</td>
          <td>R$ ${valorNum.toFixed(2)}</td>
          <td>${item.tipo}</td>
          <td>${item.vencimento}</td>
          <td>${item.status}</td>
          <td class="acoes">
            <button onclick="remover('${item.id}')">üóëÔ∏è</button>
            <button onclick="marcarPago('${item.id}')">‚úîÔ∏è</button>
          </td>
        `;
        tabela.appendChild(tr);

        if (item.tipo === 'entrada') entradas += valorNum;
        else if (item.tipo === 'saida') saidas += valorNum;
      }
    });

    atualizarGrafico(entradas, saidas);
    atualizarTotais(entradas, saidas);
  }

  function atualizarTotais(entradas, saidas) {
    const saldo = entradas - saidas;
    resumoMensal.innerHTML = `
      üí∞ Entradas: R$ ${entradas.toFixed(2)} &nbsp; | &nbsp;
      üì§ Sa√≠das: R$ ${saidas.toFixed(2)} &nbsp; | &nbsp;
      üßæ Saldo: <span style="color:${saldo >= 0 ? 'green' : 'red'}">R$ ${saldo.toFixed(2)}</span>
    `;
  }

  async function remover(id) {
    if (id) {
      await fetch(`${API_URL}/id/${id}`, { method: 'DELETE' });
      carregarDados();
    }
  }

  async function marcarPago(id) {
    if (id) {
      await fetch(`${API_URL}/id/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: { status: 'pago' } })
      });
      carregarDados();
    }
  }

  function atualizarGrafico(entradas, saidas) {
    const saldo = entradas - saidas;
    const ctx = document.getElementById('grafico').getContext('2d');
    if (grafico) grafico.destroy();
    grafico = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Entradas', 'Sa√≠das', 'Saldo'],
        datasets: [{
          label: 'R$',
          data: [entradas, saidas, saldo],
          backgroundColor: ['#0d6efd', '#dc3545', '#198754']
        }]
      }
    });
  }

  mesAnteriorBtn.onclick = () => {
    if (indiceMesAtual > 0) {
      indiceMesAtual--;
      atualizarTela();
    }
  };

  proximoMesBtn.onclick = () => {
    if (indiceMesAtual < mesesDisponiveis.length - 1) {
      indiceMesAtual++;
      atualizarTela();
    }
  };

  carregarDados();
</script>
</body>
</html>
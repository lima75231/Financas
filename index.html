<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle Financeiro Moderno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
    }

    /* Anima√ß√µes para fade in e fade out */
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }

    .fade-out {
      animation: fadeOut 0.4s ease forwards;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }

    @keyframes fadeOut {
      from {opacity: 1; transform: translateY(0);}
      to {opacity: 0; transform: translateY(10px);}
    }

    .table-responsive {
      max-height: 400px;
      overflow-y: auto;
    }

    .pendente {
      background-color: #fff3cd !important;
    }
  </style>
</head>
<body>
  <div class="container">

    <h1 class="text-center mb-4">Controle Financeiro</h1>

    <!-- Formul√°rio -->
    <form id="form" class="row gy-2 gx-3 align-items-center justify-content-center mb-4">
      <div class="col-sm-12 col-md-3">
        <input type="text" id="descricao" class="form-control" placeholder="Descri√ß√£o" required />
      </div>
      <div class="col-sm-6 col-md-2">
        <input type="text" id="valor" class="form-control" placeholder="Valor (ex: 112,53)" required />
      </div>
      <div class="col-sm-6 col-md-2">
        <input type="date" id="vencimento" class="form-control" required />
      </div>
      <div class="col-sm-6 col-md-2">
        <select id="tipo" class="form-select" required>
          <option value="entrada">Entrada</option>
          <option value="saida">Sa√≠da</option>
        </select>
      </div>
      <div class="col-sm-6 col-md-2">
        <select id="status" class="form-select" required>
          <option value="pago">Pago</option>
          <option value="pendente">Pendente</option>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Adicionar</button>
      </div>
    </form>

    <!-- Navega√ß√£o por m√™s -->
    <div class="d-flex justify-content-center align-items-center mb-3 gap-3">
      <button id="mesAnterior" class="btn btn-outline-secondary">‚Üê M√™s Anterior</button>
      <h5 id="mesAtualTexto" class="mb-0"></h5>
      <button id="proximoMes" class="btn btn-outline-secondary">Pr√≥ximo M√™s ‚Üí</button>
    </div>

    <!-- Tabela de lan√ßamentos -->
    <div class="table-responsive mb-4">
      <table class="table table-striped table-hover align-middle text-center">
        <thead class="table-dark">
          <tr>
            <th>Descri√ß√£o</th>
            <th>Valor</th>
            <th>Tipo</th>
            <th>Vencimento</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabela"></tbody>
      </table>
    </div>

    <!-- Resumo mensal -->
    <div id="resumoMensal" class="text-center fs-5 fw-semibold mb-4"></div>

    <!-- Dashboard com gr√°ficos e totais gerais -->
    <div class="card p-3 mb-5 shadow-sm">
      <h2 class="text-center mb-4">Dashboard Consolidado</h2>
      
      <div class="row justify-content-center">
        <div class="col-md-6 mb-4">
          <h5 class="text-center">Resumo Financeiro Mensal</h5>
          <canvas id="grafico"></canvas>
        </div>

        <div class="col-md-6 mb-4">
          <h5 class="text-center">Evolu√ß√£o Financeira Mensal</h5>
          <canvas id="graficoLinha"></canvas>
        </div>
      </div>

      <div id="resumoGeral" class="text-center fs-5 fw-semibold mt-4"></div>
    </div>

  </div>

<script>
  const API_URL = 'https://sheetdb.io/api/v1/vr5v5x0y9am0j';

  const form = document.getElementById('form');
  const tabela = document.getElementById('tabela');
  const mesAtualTexto = document.getElementById('mesAtualTexto');
  const mesAnteriorBtn = document.getElementById('mesAnterior');
  const proximoMesBtn = document.getElementById('proximoMes');
  const resumoMensal = document.getElementById('resumoMensal');
  const resumoGeral = document.getElementById('resumoGeral');

  let dadosOriginais = [];
  let mesesDisponiveis = [];
  let indiceMesAtual = 0;

  let graficoBarra;
  let graficoLinha;

  // Formata data para dd/mm/aaaa
  function formatarData(dataISO) {
    if (!dataISO) return '';
    const [ano, mes, dia] = dataISO.split('-');
    return `${dia}/${mes}/${ano}`;
  }

  // Converte dd/mm/aaaa para {dia, mes, ano}
  function formatarDataParaFiltro(data) {
    const [dia, mes, ano] = data.split('/');
    return { dia, mes, ano };
  }

  // Adiciona novo lan√ßamento na planilha via API
  form.onsubmit = async (e) => {
    e.preventDefault();

    const novo = {
      id: Date.now().toString(),
      descricao: form.descricao.value.trim(),
      valor: form.valor.value.replace(',', '.').trim(),
      tipo: form.tipo.value,
      vencimento: formatarData(form.vencimento.value),
      status: form.status.value
    };

    // Valida√ß√£o b√°sica
    if (!novo.descricao || isNaN(parseFloat(novo.valor))) {
      alert('Preencha descri√ß√£o e valor corretamente.');
      return;
    }

    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: novo })
    });

    form.reset();
    await carregarDados();
  };

  // Carrega todos os dados e organiza meses dispon√≠veis
  async function carregarDados() {
    const res = await fetch(API_URL);
    const dados = await res.json();
    dadosOriginais = dados;

    const chavesMesAno = new Set();
    dados.forEach(item => {
      const { mes, ano } = formatarDataParaFiltro(item.vencimento);
      chavesMesAno.add(`${mes}/${ano}`);
    });

    mesesDisponiveis = Array.from(chavesMesAno).sort((a,b) => {
      const [m1,y1] = a.split('/');
      const [m2,y2] = b.split('/');
      return new Date(`${y1}-${m1}-01`) - new Date(`${y2}-${m2}-01`);
    });

    // Ajusta √≠ndice caso fora do range
    if (indiceMesAtual >= mesesDisponiveis.length) indiceMesAtual = mesesDisponiveis.length - 1;
    if (indiceMesAtual < 0) indiceMesAtual = 0;

    atualizarTela();
    atualizarTotaisGerais();
    atualizarGraficoLinha();
  }

  // Atualiza a tabela e resumo mensal para o m√™s selecionado
  function atualizarTela() {
    const chave = mesesDisponiveis[indiceMesAtual];
    if (!chave) {
      mesAtualTexto.textContent = 'Sem dados';
      tabela.innerHTML = '';
      resumoMensal.innerHTML = '';
      return;
    }
    const [mesSelecionado, anoSelecionado] = chave.split('/');
    mesAtualTexto.textContent = `${mesSelecionado}/${anoSelecionado}`;

    tabela.innerHTML = '';
    let entradas = 0, saidas = 0;

    dadosOriginais.forEach(item => {
      const { mes, ano } = formatarDataParaFiltro(item.vencimento);
      if (mes === mesSelecionado && ano === anoSelecionado) {
        const tr = document.createElement('tr');
        if (item.status === 'pendente') tr.classList.add('pendente');
        tr.classList.add('fade-in');

        const valorNum = parseFloat(item.valor);

        tr.innerHTML = `
          <td>${item.descricao}</td>
          <td>R$ ${valorNum.toFixed(2)}</td>
          <td>${item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1)}</td>
          <td>${item.vencimento}</td>
          <td>${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" title="Remover" onclick="remover('${item.id}', this)">üóëÔ∏è</button>
            <button class="btn btn-sm btn-outline-success" title="Marcar como Pago" onclick="marcarPago('${item.id}', this)">‚úîÔ∏è</button>
          </td>
        `;
        tabela.appendChild(tr);

        if (item.tipo === 'entrada') entradas += valorNum;
        else if (item.tipo === 'saida') saidas += valorNum;
      }
    });

    atualizarGraficoBarra(entradas, saidas);
    atualizarResumoMensal(entradas, saidas);
  }

  // Atualiza resumo mensal textual
  function atualizarResumoMensal(entradas, saidas) {
    const saldo = entradas - saidas;
    resumoMensal.innerHTML = `
      üí∞ Entradas: R$ ${entradas.toFixed(2)} &nbsp; | &nbsp;
      üì§ Sa√≠das: R$ ${saidas.toFixed(2)} &nbsp; | &nbsp;
      üßæ Saldo: <span class="fw-bold text-${saldo >= 0 ? 'success' : 'danger'}">R$ ${saldo.toFixed(2)}</span>
    `;
  }

  // Remove lan√ßamento com anima√ß√£o
  async function remover(id, btn) {
    if (!confirm('Deseja remover este lan√ßamento?')) return;

    // Anima√ß√£o fade-out na linha da tabela
    const tr = btn.closest('tr');
    tr.classList.add('fade-out');

    // Aguarda anima√ß√£o antes de remover
    setTimeout(async () => {
      await fetch(`${API_URL}/id/${id}`, { method: 'DELETE' });
      await carregarDados();
    }, 400);
  }

  // Marca lan√ßamento como pago com anima√ß√£o
  async function marcarPago(id, btn) {
    await fetch(`${API_URL}/id/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: { status: 'pago' } })
    });
    await carregarDados();
  }

  // Atualiza gr√°fico de barras mensal
  function atualizarGraficoBarra(entradas, saidas) {
    const saldo = entradas - saidas;
    const ctx = document.getElementById('grafico').getContext('2d');
    if (graficoBarra) graficoBarra.destroy();

    graficoBarra = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Entradas', 'Sa√≠das', 'Saldo'],
        datasets: [{
          label: 'R$',
          data: [entradas, saidas, saldo],
          backgroundColor: ['#0d6efd', '#dc3545', '#198754']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Atualiza totais gerais abaixo do dashboard
  function atualizarTotaisGerais() {
    let totalEntradas = 0, totalSaidas = 0;
    dadosOriginais.forEach(item => {
      const valor = parseFloat(item.valor);
      if (item.tipo === 'entrada') totalEntradas += valor;
      else if (item.tipo === 'saida') totalSaidas += valor;
    });
    const saldo = totalEntradas - totalSaidas;

    resumoGeral.innerHTML = `
      üîÑ <strong>Total Geral</strong> ‚Äî 
      üí∞ Entradas: R$ ${totalEntradas.toFixed(2)} &nbsp; | &nbsp;
      üì§ Sa√≠das: R$ ${totalSaidas.toFixed(2)} &nbsp; | &nbsp;
      üßæ Saldo: <span class="fw-bold text-${saldo >= 0 ? 'success' : 'danger'}">R$ ${saldo.toFixed(2)}</span>
    `;
  }

  // Atualiza gr√°fico de linha evolu√ß√£o mensal
  function atualizarGraficoLinha() {
    const dadosPorMes = {};

    dadosOriginais.forEach(item => {
      const { mes, ano } = formatarDataParaFiltro(item.vencimento);
      const chave = `${mes}/${ano}`;
      if (!dadosPorMes[chave]) dadosPorMes[chave] = { entradas: 0, saidas: 0 };
      const valor = parseFloat(item.valor);
      if (item.tipo === 'entrada') dadosPorMes[chave].entradas += valor;
      else if (item.tipo === 'saida') dadosPorMes[chave].saidas += valor;
    });

    const labels = Object.keys(dadosPorMes).sort((a,b) => {
      const [m1,y1] = a.split('/');
      const [m2,y2] = b.split('/');
      return new Date(`${y1}-${m1}-01`) - new Date(`${y2}-${m2}-01`);
    });

    const entradas = labels.map(k => dadosPorMes[k].entradas);
    const saidas = labels.map(k => dadosPorMes[k].saidas);
    const saldos = labels.map((_, i) => entradas[i] - saidas[i]);

    const ctx = document.getElementById('graficoLinha').getContext('2d');
    if (graficoLinha) graficoLinha.destroy();

    graficoLinha = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Entradas',
            data: entradas,
            borderColor: '#0d6efd',
            backgroundColor: '#0d6efd22',
            fill: true,
            tension: 0.3
          },
          {
            label: 'Sa√≠das',
            data: saidas,
            borderColor: '#dc3545',
            backgroundColor: '#dc354522',
            fill: true,
            tension: 0.3
          },
          {
            label: 'Saldo',
            data: saldos,
            borderColor: '#198754',
            backgroundColor: '#19875422',
            fill: true,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Navega√ß√£o meses
  mesAnteriorBtn.onclick = () => {
    if (indiceMesAtual > 0) {
      indiceMesAtual--;
      atualizarTela();
    }
  };

  proximoMesBtn.onclick = () => {
    if (indiceMesAtual < mesesDisponiveis.length - 1) {
      indiceMesAtual++;
      atualizarTela();
    }
  };

  // Inicializa carregando dados
  carregarDados();
</script>

<!-- Bootstrap Bundle JS (popper + bootstrap) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>